<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DMARC Report Viewer</title>
  <link rel="stylesheet" href="viewer.css">
</head>
<body>
  <div class="container">
    <header class="header">
      <h1>DMARC Report Viewer</h1>
      <div class="header-actions">
        <div id="drop-zone" class="drop-zone-inline">
          <span>Drop file or</span>
          <button id="file-picker-btn" class="btn-secondary">Select File</button>
          <input type="file" id="file-input" accept=".xml,.gz,.zip" hidden>
        </div>
        <div id="export-buttons" class="export-buttons hidden">
          <button id="view-xml-btn" class="btn-export" title="View raw XML source">View XML</button>
          <button id="export-json" class="btn-export">Export JSON</button>
          <button id="export-csv" class="btn-export">Export CSV</button>
        </div>
      </div>
    </header>

    <div id="loading" class="loading hidden">
      <div class="spinner"></div>
      <span>Processing report...</span>
    </div>

    <div id="error" class="error hidden"></div>

    <!-- Enrichment Banner (for large reports) -->
    <div id="enrichment-banner" class="enrichment-banner hidden">
      <div class="enrichment-content">
        <div class="enrichment-info">
          <strong>Large Report Detected</strong>
          <span id="enrichment-message">This report has many records. IP enrichment may be slow.</span>
        </div>
        <div class="enrichment-actions">
          <button id="enrich-now-btn" class="btn-primary">Enrich IPs Now</button>
          <button id="skip-enrichment-btn" class="btn-secondary">Skip Enrichment</button>
        </div>
      </div>
    </div>

    <main id="report" class="report hidden">
      <!-- Summary Cards with Progress Bars -->
      <section class="summary-section">
        <div class="summary-cards">
          <div class="card card-total">
            <div class="card-value" id="total-messages">0</div>
            <div class="card-label">Total Messages</div>
          </div>
          <div class="card card-pass">
            <div class="card-value" id="passed-both">0</div>
            <div class="card-label">Fully Compliant</div>
            <div class="progress-bar">
              <div class="progress-fill pass" id="progress-both"></div>
            </div>
            <div class="card-percent" id="percent-both">0%</div>
          </div>
          <div class="card card-dkim">
            <div class="card-value" id="passed-dkim">0</div>
            <div class="card-label">DKIM Pass</div>
            <div class="progress-bar">
              <div class="progress-fill dkim" id="progress-dkim"></div>
            </div>
            <div class="card-percent" id="percent-dkim">0%</div>
          </div>
          <div class="card card-spf">
            <div class="card-value" id="passed-spf">0</div>
            <div class="card-label">SPF Pass</div>
            <div class="progress-bar">
              <div class="progress-fill spf" id="progress-spf"></div>
            </div>
            <div class="card-percent" id="percent-spf">0%</div>
          </div>
        </div>
        <div class="summary-cards failure-cards">
          <div class="card card-fail">
            <div class="card-value" id="failed-both">0</div>
            <div class="card-label">Failed Both</div>
          </div>
          <div class="card card-quarantine">
            <div class="card-value" id="quarantined">0</div>
            <div class="card-label">Quarantined</div>
          </div>
          <div class="card card-reject">
            <div class="card-value" id="rejected">0</div>
            <div class="card-label">Rejected</div>
          </div>
        </div>
      </section>

      <!-- Report Metadata -->
      <section class="section collapsible">
        <h2 class="section-header">
          <span>Report Information</span>
          <button class="collapse-btn" aria-label="Toggle section">▼</button>
        </h2>
        <div class="section-content">
          <div class="metadata-grid">
            <div class="metadata-item">
              <span class="metadata-label">Reporting Organization</span>
              <span class="metadata-value" id="org-name">-</span>
            </div>
            <div class="metadata-item">
              <span class="metadata-label">Report ID</span>
              <span class="metadata-value" id="report-id">-</span>
            </div>
            <div class="metadata-item">
              <span class="metadata-label">Date Range</span>
              <span class="metadata-value" id="date-range">-</span>
            </div>
            <div class="metadata-item">
              <span class="metadata-label">Contact</span>
              <span class="metadata-value" id="contact-email">-</span>
            </div>
          </div>
        </div>
      </section>

      <!-- Policy Published -->
      <section class="section collapsible">
        <h2 class="section-header">
          <span>Published Policy</span>
          <button class="collapse-btn" aria-label="Toggle section">▼</button>
        </h2>
        <div class="section-content">
          <div class="metadata-grid">
            <div class="metadata-item">
              <span class="metadata-label">Domain</span>
              <span class="metadata-value" id="policy-domain">-</span>
            </div>
            <div class="metadata-item">
              <span class="metadata-label">Policy</span>
              <span class="metadata-value" id="policy-p">-</span>
            </div>
            <div class="metadata-item">
              <span class="metadata-label">Subdomain Policy</span>
              <span class="metadata-value" id="policy-sp">-</span>
            </div>
            <div class="metadata-item">
              <span class="metadata-label">DKIM Alignment</span>
              <span class="metadata-value" id="policy-adkim">-</span>
            </div>
            <div class="metadata-item">
              <span class="metadata-label">SPF Alignment</span>
              <span class="metadata-value" id="policy-aspf">-</span>
            </div>
            <div class="metadata-item">
              <span class="metadata-label">Percentage</span>
              <span class="metadata-value" id="policy-pct">-</span>
            </div>
          </div>
        </div>
      </section>

      <!-- Analysis Section -->
      <section class="section collapsible" id="analysis-section">
        <h2 class="section-header">
          <span>Analysis</span>
          <button class="collapse-btn" aria-label="Toggle section">▼</button>
        </h2>
        <div class="section-content">
          <div class="analysis-grid">
            <div class="analysis-panel" id="top-senders-panel">
              <h3>Top Sending IPs</h3>
              <div class="analysis-list" id="top-senders-list">
                <div class="analysis-loading">Loading geo data...</div>
              </div>
            </div>
            <div class="analysis-panel" id="top-failures-panel">
              <h3>Top Failing Domains</h3>
              <div class="analysis-list" id="top-failures-list">
                <div class="analysis-empty">No failures</div>
              </div>
            </div>
            <div class="analysis-panel" id="top-countries-panel">
              <h3>Top Countries</h3>
              <div class="analysis-list" id="top-countries-list">
                <div class="analysis-loading">Loading geo data...</div>
              </div>
            </div>
            <div class="analysis-panel" id="top-asns-panel">
              <h3>Top Networks (ASN)</h3>
              <div class="analysis-list" id="top-asns-list">
                <div class="analysis-loading">Loading geo data...</div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Records Table -->
      <section class="section">
        <div class="section-header-with-controls">
          <h2>Authentication Records</h2>
          <button id="toggle-filters-btn" class="btn-filter-toggle" aria-expanded="false" aria-controls="advanced-filters">
            <span class="filter-icon">&#9660;</span> Filters
            <span id="active-filter-count" class="filter-badge hidden">0</span>
          </button>
        </div>

        <!-- Advanced Filter Panel -->
        <div id="advanced-filters" class="advanced-filters hidden">
          <div class="filter-row">
            <div class="filter-group">
              <label for="filter-status">Status</label>
              <select id="filter-status">
                <option value="all">All Records</option>
                <option value="pass">Passed Only</option>
                <option value="fail">Failed Only</option>
                <option value="quarantine">Quarantined</option>
                <option value="reject">Rejected</option>
              </select>
            </div>
            <div class="filter-group">
              <label for="filter-domain">Domain</label>
              <input type="text" id="filter-domain" placeholder="e.g., example.com" autocomplete="off">
            </div>
            <div class="filter-group">
              <label for="filter-ip">Source IP</label>
              <input type="text" id="filter-ip" placeholder="e.g., 192.168.1 or CIDR" autocomplete="off">
            </div>
            <div class="filter-group">
              <label for="filter-country">Country</label>
              <select id="filter-country">
                <option value="">All Countries</option>
                <!-- Populated dynamically from data -->
              </select>
            </div>
          </div>
          <div class="filter-row">
            <div class="filter-group">
              <label for="filter-min-count">Min Messages</label>
              <input type="number" id="filter-min-count" min="1" placeholder="1">
            </div>
            <div class="filter-group">
              <label for="filter-hostname">Hostname</label>
              <input type="text" id="filter-hostname" placeholder="e.g., google.com" autocomplete="off">
            </div>
            <div class="filter-group">
              <label for="sort-by">Sort by</label>
              <select id="sort-by">
                <option value="count-desc">Count (High to Low)</option>
                <option value="count-asc">Count (Low to High)</option>
                <option value="ip">IP Address</option>
              </select>
            </div>
            <div class="filter-group filter-actions">
              <button id="apply-filters-btn" class="btn-primary btn-sm">Apply</button>
              <button id="clear-filters-btn" class="btn-secondary btn-sm">Clear</button>
            </div>
          </div>
        </div>
        <div class="table-container">
          <table class="records-table">
            <thead>
              <tr>
                <th>Source IP</th>
                <th>Hostname</th>
                <th>Location</th>
                <th>From Domain</th>
                <th>Count</th>
                <th>Disposition</th>
                <th>DKIM</th>
                <th>SPF</th>
                <th>Details</th>
              </tr>
            </thead>
            <tbody id="records-body">
            </tbody>
          </table>
        </div>
        <div id="records-summary" class="records-summary"></div>
      </section>
    </main>

    <footer class="footer">
      <p>DMARC Report Reader</p>
    </footer>
  </div>

  <!-- Report Selector Modal (for multi-file ZIPs) -->
  <div id="report-selector-modal" class="modal hidden" role="dialog" aria-labelledby="modal-title" aria-modal="true">
    <div class="modal-backdrop"></div>
    <div class="modal-content report-selector-content">
      <div class="modal-header">
        <h2 id="modal-title">Multiple Reports Found</h2>
        <button id="close-selector-modal" class="modal-close" aria-label="Close">&times;</button>
      </div>
      <div class="modal-body">
        <p class="modal-description">This ZIP file contains multiple DMARC reports. Select one to view, or combine all reports.</p>
        <div id="report-list" class="report-list">
          <!-- Populated dynamically -->
        </div>
      </div>
      <div class="modal-footer">
        <button id="combine-all-btn" class="btn-primary">Combine All Reports</button>
      </div>
    </div>
  </div>

  <!-- Raw XML Modal -->
  <div id="xml-modal" class="modal hidden" role="dialog" aria-labelledby="xml-modal-title" aria-modal="true">
    <div class="modal-backdrop"></div>
    <div class="modal-content xml-modal-content">
      <div class="modal-header">
        <h2 id="xml-modal-title">Raw DMARC XML</h2>
        <div class="modal-header-actions">
          <button id="copy-xml-btn" class="btn-secondary btn-sm">Copy to Clipboard</button>
          <button id="close-xml-modal" class="modal-close" aria-label="Close">&times;</button>
        </div>
      </div>
      <div class="modal-body xml-modal-body">
        <pre id="xml-content" class="xml-source"></pre>
      </div>
    </div>
  </div>

  <script src="../../lib/pako.min.js"></script>
  <script src="../../lib/jszip.min.js"></script>
  <script src="../parser/file-handler.js"></script>
  <script src="../parser/dmarc-parser.js"></script>
  <script src="../services/ip-lookup.js"></script>
  <script src="viewer.js"></script>
</body>
</html>
